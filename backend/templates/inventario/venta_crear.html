{% extends "inventario/base.html" %}
{% block title %}Nueva Venta{% endblock %}
{% block page_title %}Registrar Venta{% endblock %}

{% block content %}

<form method="post" class="bg-white p-6 rounded-xl shadow max-w-5xl mx-auto">
    {% csrf_token %}

    <!-- ==================== BÃšSQUEDA DE PRODUCTOS ==================== -->
    <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
        <label class="block font-bold text-lg mb-2 text-gray-800">ğŸ” Buscar y Agregar Productos</label>
        <p class="text-sm text-gray-600 mb-3">Escribe el nombre o cÃ³digo del producto para agregarlo a la venta</p>
        
        <div class="relative">
            <input 
                id="buscar-productos" 
                type="text" 
                placeholder="Ej: Laptop, cÃ³digo 100, etc..." 
                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" 
                autocomplete="off">
            <ul id="sugerencias" class="absolute top-full left-0 right-0 bg-white border-2 border-gray-300 rounded-lg mt-1 max-h-64 overflow-auto hidden shadow-lg z-50 list-none p-0 m-0"></ul>
        </div>
    </div>

    <!-- ==================== TABLA DE PRODUCTOS ==================== -->
    <div class="mb-6">
        <h3 class="font-bold text-lg mb-3 text-gray-800">ğŸ“¦ Productos Seleccionados</h3>
        
        <div class="bg-gray-50 rounded-lg border-2 border-gray-200 overflow-hidden">
            <table class="w-full" id="tabla-productos">
                <thead class="bg-gray-200 border-b-2">
                    <tr>
                        <th class="px-4 py-3 text-left">Producto</th>
                        <th class="px-4 py-3 text-center">CÃ³digo</th>
                        <th class="px-4 py-3 text-right">Precio</th>
                        <th class="px-4 py-3 text-center">Stock</th>
                        <th class="px-4 py-3 text-center">Cantidad</th>
                        <th class="px-4 py-3 text-right">Subtotal</th>
                        <th class="px-4 py-3 text-center">Eliminar</th>
                    </tr>
                </thead>
                <tbody id="tbody-productos">
                </tbody>
            </table>
            <div id="vacio" class="p-6 text-center text-gray-500">
                <p>ğŸ“­ Sin productos. Â¡Busca y agrega algunos!</p>
            </div>
        </div>
    </div>

    <!-- ==================== RESUMEN FINANCIERO ==================== -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
        <div class="text-center">
            <p class="text-sm text-gray-600">Subtotal</p>
            <p class="text-2xl font-bold text-gray-800">$<span id="subtotal">0.00</span></p>
        </div>
        <div class="text-center">
            <p class="text-sm text-gray-600">Descuento</p>
            <p class="text-2xl font-bold text-red-600">-$<span id="descuento-val">0.00</span></p>
        </div>
        <div class="text-center">
            <p class="text-sm text-gray-600">IVA (19%)</p>
            <p class="text-2xl font-bold text-orange-600">+$<span id="iva-val">0.00</span></p>
        </div>
        <div class="text-center bg-blue-100 rounded">
            <p class="text-sm text-gray-600">Total</p>
            <p class="text-3xl font-bold text-blue-700">$<span id="total-val">0.00</span></p>
        </div>
    </div>

    <!-- ==================== CONFIGURACIÃ“N ==================== -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
            <label class="block font-semibold mb-2">ğŸ’³ MÃ©todo de Pago</label>
            <select name="metodo_pago" id="metodo_pago" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                <option value="EFECTIVO">ğŸ’µ Efectivo</option>
                <option value="TARJETA">ğŸ¦ Tarjeta</option>
                <option value="TRANSFERENCIA">ğŸ“± Transferencia</option>
            </select>
        </div>

        <div>
            <label class="block font-semibold mb-2">ğŸ Descuento General</label>
            <input type="number" step="0.01" name="descuento_general" id="descuento_general" class="w-full p-3 border-2 border-gray-300 rounded-lg" value="0" min="0">
        </div>

        <div id="div-monto" class="md:col-span-2 hidden">
            <label class="block font-semibold mb-2">ğŸ’° Monto Recibido</label>
            <input type="number" step="0.01" name="monto_recibido" id="monto_recibido" class="w-full p-3 border-2 border-gray-300 rounded-lg" value="0" min="0">
            <p class="text-sm text-gray-600 mt-1">Cambio: $<span id="cambio-val">0.00</span></p>
        </div>

        <div class="md:col-span-2">
            <label class="block font-semibold mb-2">ğŸ“§ Correo del Cliente</label>
            <input type="email" name="email_cliente" class="w-full p-3 border-2 border-gray-300 rounded-lg" placeholder="cliente@correo.com" required>
        </div>
    </div>

    <!-- ==================== BOTÃ“N ==================== -->
    <button type="submit" id="btn-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-bold text-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed">
        ğŸ’° Registrar Venta
    </button>

    <!-- Inputs hidden para productos -->
    <div id="inputs-hidden"></div>
</form>

<script>
let carrito = {}; // {id_producto: {id, nombre, codigo, precio, stock, cantidad}}

const inputBuscar = document.getElementById('buscar-productos');
const ulSugerencias = document.getElementById('sugerencias');

// Buscar productos
inputBuscar.addEventListener('input', async (e) => {
    const q = e.target.value.trim();
    if (!q || q.length < 1) {
        ulSugerencias.classList.add('hidden');
        return;
    }

    try {
        const resp = await fetch(`/inventario/api/productos/buscar/?q=${encodeURIComponent(q)}`);
        if (!resp.ok) throw new Error('Error en bÃºsqueda');
        const productos = await resp.json();

        if (productos.length === 0) {
            ulSugerencias.innerHTML = '<li class="px-4 py-2 text-gray-500">No encontrado</li>';
            ulSugerencias.classList.remove('hidden');
            return;
        }

        ulSugerencias.innerHTML = productos.map(p => `
            <li class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b transition" data-id="${p.id}" data-nombre="${p.nombre}" data-codigo="${p.codigo}" data-precio="${p.precio_venta}" data-stock="${p.stock}">
                <div class="font-semibold text-gray-800">${p.nombre}</div>
                <div class="text-sm text-gray-600">Cod: ${p.codigo} | $${parseFloat(p.precio_venta).toFixed(2)} | Stock: ${p.stock}</div>
            </li>
        `).join('');
        ulSugerencias.classList.remove('hidden');
    } catch (err) {
        console.error(err);
        ulSugerencias.classList.add('hidden');
    }
});

// Click en sugerencia
ulSugerencias.addEventListener('click', (e) => {
    const li = e.target.closest('li[data-id]');
    if (!li) return;

    const id = li.dataset.id;
    const nombre = li.dataset.nombre;
    const codigo = li.dataset.codigo;
    const precio = parseFloat(li.dataset.precio);
    const stock = parseInt(li.dataset.stock);

    if (carrito[id]) {
        // Aumentar cantidad
        if (carrito[id].cantidad < stock) {
            carrito[id].cantidad++;
        }
    } else {
        // Agregar nuevo
        carrito[id] = {
            id, nombre, codigo, precio, stock, cantidad: 1
        };
    }

    renderCarrito();
    inputBuscar.value = '';
    ulSugerencias.classList.add('hidden');
});

function renderCarrito() {
    const tbody = document.getElementById('tbody-productos');
    const vacio = document.getElementById('vacio');
    const items = Object.values(carrito);

    if (items.length === 0) {
        tbody.innerHTML = '';
        vacio.classList.remove('hidden');
        document.getElementById('btn-submit').disabled = true;
        return;
    }

    vacio.classList.add('hidden');
    document.getElementById('btn-submit').disabled = false;

    tbody.innerHTML = items.map(p => {
        const subtotal = (p.precio * p.cantidad).toFixed(2);
        return `
            <tr class="border-b hover:bg-gray-100">
                <td class="px-4 py-3 font-semibold">${p.nombre}</td>
                <td class="px-4 py-3 text-center text-gray-600">${p.codigo}</td>
                <td class="px-4 py-3 text-right text-green-700 font-bold">$${p.precio.toFixed(2)}</td>
                <td class="px-4 py-3 text-center text-blue-600">${p.stock}</td>
                <td class="px-4 py-3 text-center">
                    <input type="number" value="${p.cantidad}" min="1" max="${p.stock}" class="w-16 p-1 border rounded text-center input-cant" data-id="${p.id}">
                </td>
                <td class="px-4 py-3 text-right font-bold">$${subtotal}</td>
                <td class="px-4 py-3 text-center">
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded btn-del" data-id="${p.id}">ğŸ—‘ï¸</button>
                </td>
            </tr>
        `;
    }).join('');

    // Input cantidad
    document.querySelectorAll('.input-cant').forEach(inp => {
        inp.addEventListener('change', function() {
            const id = this.dataset.id;
            const cant = parseInt(this.value) || 1;
            if (cant > 0 && cant <= carrito[id].stock) {
                carrito[id].cantidad = cant;
            } else {
                this.value = carrito[id].cantidad;
            }
            renderCarrito();
            calcularTotales();
        });
    });

    // BotÃ³n eliminar
    document.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            delete carrito[btn.dataset.id];
            renderCarrito();
            calcularTotales();
        });
    });

    calcularTotales();
}

function calcularTotales() {
    let subtotal = Object.values(carrito).reduce((sum, p) => sum + (p.precio * p.cantidad), 0);
    const desc = parseFloat(document.getElementById('descuento_general').value) || 0;
    const conDesc = subtotal - desc;
    const iva = conDesc * 0.19;
    const total = conDesc + iva;
    const monto = parseFloat(document.getElementById('monto_recibido').value) || 0;
    const cambio = Math.max(0, monto - total);

    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('descuento-val').textContent = desc.toFixed(2);
    document.getElementById('iva-val').textContent = iva.toFixed(2);
    document.getElementById('total-val').textContent = total.toFixed(2);
    document.getElementById('cambio-val').textContent = cambio.toFixed(2);
}

document.getElementById('descuento_general').addEventListener('input', calcularTotales);
document.getElementById('monto_recibido').addEventListener('input', calcularTotales);

document.getElementById('metodo_pago').addEventListener('change', function() {
    document.getElementById('div-monto').classList.toggle('hidden', this.value !== 'EFECTIVO');
});

// Generar inputs hidden al enviar
document.querySelector('form').addEventListener('submit', (e) => {
    if (Object.keys(carrito).length === 0) {
        e.preventDefault();
        alert('Agrega al menos un producto');
        return;
    }

    const div = document.getElementById('inputs-hidden');
    div.innerHTML = Object.entries(carrito).map(([id, p]) => 
        `<input type="hidden" name="prod_${id}" value="${p.cantidad}">`
    ).join('');
});

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('metodo_pago').dispatchEvent(new Event('change'));
});
</script>

{% endblock %}